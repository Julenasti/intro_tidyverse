---
title: "Introduction to The Tidyverse for data analysis"
author: "Julen Astigarraga"
date: "15/06/2022"
output:
  html_document:
    keep_md: yes
    toc: true
    toc_depth: 2
    css: styles.css
editor_options: 
  chunk_output_type: inline
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE, message = FALSE)
library(here)
library(easyclimate)
library(patchwork)
library(viridis)
library(ggpmisc)
library(fs)
library(future)
library(furrr)
library(rmarkdown)

library(tidyverse)

```

```{r tidydata, echo = FALSE, fig.align = "center", fig.cap = "Illustrations from Allison Horst"}
knitr::include_graphics(here("03-figures", "01-tidydata.jpg"))
```

In this R Markdown file you will find the basic concepts to understand the core tidyverse collection of R packages (<https://www.tidyverse.org/>)

# Problem we are going to work with

In the city council of Sevilla there are still discrepancies about the existence of anthropogenic climate change. Some parties are of the opinion that it does not exist, others think that it exists but that it is not due to anthropogenic causes and others argue that all the scientific evidence leaves no doubt that it exists and that it is due to anthropogenic causes. The parties that believe that anthropogenic climate change exists have asked you, a group of experts, to produce a report that clearly shows how the increase in CO~2~ emissions has gone hand in hand with the increase in temperature in recent decades. How would you solve this issue?

-   The data could be obtained, for example, from the following information sources: Climate data for Sevilla: <https://verughub.github.io/easyclimate/index.html>

-   CO~2~ emissions data for Spain: <https://edgar.jrc.ec.europa.eu/report_2020#data_download>

```{r framework, echo = FALSE, fig.align = "center", fig.cap = "Wickham & Grolemund (2017)"}
knitr::include_graphics(here("03-figures", "02-framework.jpg"))
```

## Download data

```{r download}
coords <- data.frame(
  lon = -5.99629,
  lat = 37.3826
)

ggplot() +
  borders(regions = c("Spain", "Portugal", "France")) +
  geom_point(data = coords, aes(x = lon, y = lat)) +
  coord_fixed(xlim = c(-10, 2), ylim = c(36, 44), ratio = 1.3) +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw()

# tmin <- get_daily_climate(
#   coords,
#   period = 1950:2020,
#   climatic_var = "Tmin"
#   )
# 
# tmax <- get_daily_climate(
#   coords,
#   period = 1950:2020,
#   climatic_var = "Tmax"
#   )

# saveRDS(tmin, file = here("00-raw", "tmin_sevilla.rds"))
# saveRDS(tmax, file = here("00-raw", "tmax_sevilla.rds"))
```

# The Tidyverse

```{r tidyverse, echo = FALSE, fig.align = "center"}
knitr::include_graphics(here("03-figures", "03-tidyverse-packages.png"))
```

> The tidyverse is an opinionated collection of R packages designed for data science. All packages share an underlying design philosophy, grammar, and data structures. --- [tidyverse](https://www.tidyverse.org/)

> The tidyverse is fundamentally human centred (Wickham et al. JOSS, 2019) ---

`r emo::ji("pencil")` *few advantages compared to base R*

## 1\| readr (read rectangular data)

-   `r emo::ji("pencil")` Use a consistent naming scheme for the parameters (e.g. col_names and col_types not header and colClasses)
-   Are much faster (up to 10x)

1.  Read CO~2~ and temperature data

```{r readr}
co_data <- read_csv(here("02-data", "co2.csv"))
tmin_data <- readRDS(file = here("02-data", "tmin_sevilla.rds"))
tmax_data <- readRDS(file = here("02-data", "tmax_sevilla.rds"))
```

```{r glimpse}
glimpse(co_data)
head(co_data)
tail(co_data)
summary(co_data)
names(co_data)

glimpse(tmin_data)
glimpse(tmax_data)
```

## 2\| tibble (modern reimagining of the data.frame)

-   `r emo::ji("pencil")` Allow to work with list-columns
-   Assists the user in displaying the printing
-   Never do partial matching

```{r tibble-data.frame}
class(co_data)

co_data_df <- as.data.frame(co_data)
co_data <- as_tibble(co_data)

co_data_df$Secto
co_data$Secto
```

## 3\| tidyr (tidy data)

-   `r emo::ji("pencil")`tidy data 3 characteristics:

1.  Every column is a variable
2.  Every row is an observation
3.  Every cell is a single measurement

`r emo::ji("magnifying")` [Check out this post by Julie Lowndes and Allison Horst](https://www.openscapes.org/blog/2020/10/12/tidy-data/)

4\. Change CO~2~ annual data to long format

```{r tidyr}
glimpse(co_data)

co_data_l <- co_data |>
  pivot_longer(
    cols = "1970":"2019",
    names_to = "co_year",
    values_to = "co_value"
  )

glimpse(co_data_l)
```

## 4\| dplyr (data manipulation)

```{r dplyr, echo = FALSE, fig.align = "center", fig.cap = "Illustrations from Allison Horst"}
knitr::include_graphics(here("03-figures", "04-dplyr.png"))
```

-   `r emo::ji("pencil")` consistent set of verbs
-   pipes (`%>%` &`|>`)

1.  Filter data from Spain
2.  Delete (not select) those variables that you're not interested in

```{r filter-select}
glimpse(co_data_l)

co_data_l_sp <- co_data_l |>
  filter(country_name == "Spain and Andorra") |>
  select(!country_name)

glimpse(co_data_l_sp)

glimpse(tmin_data)

tmin_data_sel <- tmin_data |>
  select(!c(ID_coords))

tmax_data_sel <- tmax_data |>
  select(!c(ID_coords))

glimpse(tmin_data_sel)

glimpse(tmax_data_sel)
```

3\. Bind/Join both tmin and tmax data

```{r bind-join}
temp_data <- bind_cols(tmin_data_sel, tmax_data_sel)
glimpse(temp_data)

temp_data <- full_join(tmin_data_sel, tmax_data_sel,
                       by = c("lat", "lon", "date"))
glimpse(temp_data)
```

4\. Create a new variable (column) with mutate to get mean temperature data

```{r mutate}
daily_tmean <- temp_data %>%
  mutate(
    Tmean = (Tmin + Tmax) / 2,
    date = as.Date(date),
    month = format(date, format = "%m"),
    year = format(date, format = "%Y")
  )
```

5\. But wait! We're interested in annual data not daily data

```{r group_by-summarise}
glimpse(co_data_l_sp)
glimpse(daily_tmean)

annual <- daily_tmean |>
  group_by(year) |>
  summarise(
    Tmean.year = mean(Tmean)
    )

glimpse(annual)
```

6\. Join both datasets and review what we have learned so far

```{r review}
co_temp <- full_join(
  co_data_l_sp, annual, by = c("co_year" = "year")
)

glimpse(co_temp)

co_temp_all <- co_temp |>
  mutate(
    co_value = as.numeric(co_value),
    co_year = as.numeric(co_year),
  ) |>
  group_by(co_year) |>
  summarise(
    co_all = sum(co_value),
    Tmean.year = first(Tmean.year)
  )

glimpse(co_temp_all)
```

## 5\| ggplot (data visualisation)

`r emo::ji("pencil")` `r emo::ji("shocked")` ggplot2 is a system for declaratively creating graphics, based on The Grammar of Graphics. You provide the data, tell ggplot2 how to map variables to aesthetics, what graphical primitives to use, and it takes care of the details.

1.  Visualise the relationship between annual CO~2~ emissions and years
2.  Visualise the relationship between annual mean temperature and years
3.  Visualise the relationship between annual CO~2~ emissions and mean temperature

```{r ggplot}
gg_ye_co <- ggplot(co_temp_all, 
                   aes(x = co_year, y = co_all,
                       color = co_year)) +
  geom_line() +
  # geom_smooth(color = "#E1BE6A") +
  geom_smooth(method = "lm", color = "#40B0A6")

gg_ye_temp <- ggplot(co_temp_all, 
                     aes(x = co_year, y = Tmean.year,
                         color = co_year)) +
  geom_point() +
  # geom_smooth(color = "#E1BE6A") +
  geom_smooth(method = "lm", color = "#40B0A6")

gg_co_temp <- ggplot(co_temp_all, aes(x = co_all, y = Tmean.year)) +
  geom_point() +
  # geom_smooth(color = "#E1BE6A") +
  geom_smooth(method = "lm", color = "#40B0A6")


(gg_ye_co + gg_ye_temp) / gg_co_temp

co_temp <- co_temp |>
  mutate(
    across(c(co_value, co_year), ~as.numeric(.x))
  )
```

## 6\| stringr (string manipulation)

-   `r emo::ji("pencil")` All functions in stringr start with str\_ and take a vector of strings as the first argument
-   Make working with strings as easy as possible

## 7\| forcats (solve problems with factors)

-   `r emo::ji("pencil")` Solve common problems with factors

1.  Detect and highlight all sectors starting with the word "Other"
2.  Put the sectors beginning with "Other" at the end of the legend

```{r stringr-forcats}
gg_ye_co_sec <- co_temp |>
  drop_na(Sector) |>
  ggplot(aes(x = co_year, y = co_value, color = Sector)) +
  geom_line()

co_temp_fs <- co_temp |>
  mutate(
    transport = str_detect(Sector, "Transport"),
    Sector = fct_relevel(Sector, "Other industrial combustion", after = Inf),
    Sector = fct_relevel(Sector, "Other sectors", after = Inf)
    )

glimpse(co_temp_fs)

gg_ye_co_sec <- co_temp_fs |>
  drop_na(Sector) |>
  ggplot(aes(x = co_year, y = co_value, color = Sector)) +
  geom_line() +
  geom_line(data = co_temp_fs |> filter(transport == T),
            aes(x = co_year, y = co_value, color = Sector),
            size = 1.5)

(gg_ye_co + gg_ye_co_sec) /
  (gg_ye_temp + gg_co_temp)
```

## 8\| purrr (functional programming)

-   `r emo::ji("pencil")` The idea of passing a function to another function is an extremely powerful idea, and it’s one of the behaviours that makes R a functional programming language.
-   Functional programming makes your code easier to write and to read (for loops are quite verbose, and require quite a bit of bookkeeping code that is duplicated for every for loop).
-   The apply family of functions in base R solve a similar problem, but purrr is more consistent and thus is easier to learn.

```{r loop-purrr, echo = FALSE, fig.align = "center", fig.cap = "Illustrations from Hadley Wickham's talk The Joy of Functional Programming (for Data Science)"}
knitr::include_graphics(here("03-figures", "05-forloops.png"))
knitr::include_graphics(here("03-figures", "06-map_frosting.png"))
```

1.  Create a function to add a theme to a ggplot
2.  Apply this function to all ggplots at once

-   `r emo::ji("magnifying")` [Check out this post by Rebecca Barter](https://www.rebeccabarter.com/blog/2019-08-19_purrr/)

```{r purrr}
glimpse(co_data_l)

co_data_l[, "country_name"]

select_example <- function(dat, x){
  return(dat[, x])
}

select_example(co_data_l, "country_name")

gg_theme <- function(gg, units, title){
  gg +
    geom_smooth(method = "lm", color = "firebrick", size = 1.3) +
    stat_fit_glance(
        method = "lm",
        label.x = "left",
        label.y = "top",
        method.args = list(formula = y ~ x),
        mapping = aes(
          label = sprintf('italic(R^2)~"="~%.3f~~italic(P)~"="~%.2g',
                          after_stat(r.squared), after_stat(p.value))
        ),
        parse = TRUE
      ) +
    geom_point(alpha = .5) +
    scale_y_continuous(labels = function(x){paste0(x, units)}) +
    scale_color_viridis_c(option = "turbo", direction = -1,
                          name = NULL,
                          breaks = seq(1950, 2020, 10)) +
    guides(color = guide_colorsteps(barwidth = unit(30, "lines"),
                                    barheight = unit(.4, "lines"))) +
    labs(y = NULL, x = NULL,
         title = title) +
    theme(
      panel.grid.major = element_line(colour = "grey90", size = 0.5),
      panel.background = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "top",
      legend.title = element_text(size = 14, color = "grey20"),
      legend.text = element_text(size = 12, color = "grey50"),
      plot.title = element_text(size = 22, margin = margin(b = 15)),
      plot.subtitle = element_text(size = 14, margin = margin(b = 15)),
      plot.caption = element_text(size = 14, color = "grey50", margin = margin(t = 25)),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      axis.text = element_text(size = 14),
      axis.line.x = element_line(color = "grey20"),
      axis.ticks.x = element_line(color = "grey20"),
      plot.margin = margin(20, 20, 10, 20)
      )
}

gg_ye_temp_th <- gg_theme(
  gg = gg_ye_temp,
  units = "°C",
  title = "Annual mean temperature"
)

gg_ye_co_th <- gg_theme(
  gg = gg_ye_co,
  units = " Mt CO2/yr",
  title = bquote(Annual~CO[2]~emissions)
)

gg_co_temp_th <- gg_theme(
  gg = gg_co_temp,
  units = "°C",
  title = bquote(
    Annual~mean~temperature~vs~Annual~CO[2]~emissions
    )
) +
  scale_x_continuous(labels = function(x){paste0(x, " Mt CO2/yr")})

arg_3 <- list(
  gg = list(gg_ye_co, gg_ye_temp, gg_co_temp),
  units = c("°C", "Mt CO2/yr", "°C"),
  title = c(
    "Annual mean temperature",
    "Annual CO2 emissions",
    "Annual mean temperature vs Annual CO2 emissions"
  )
  )

arg_3 |>
  pmap(gg_theme) |>
  reduce(`+`)

gg_ye_co_sec_th <- gg_ye_co_sec +
    geom_point(alpha = .5) +
    scale_y_continuous(labels = function(x){paste0(x, " Mt CO2/yr")}) +
    labs(y = NULL, x = NULL,
         title = bquote(Annual~CO[2]~emissions~by~sectors)) +
    theme(
      panel.grid.major = element_line(colour = "grey90", size = 0.5),
      panel.background = element_blank(),
      panel.grid.minor = element_blank(),
      legend.key = element_blank(),
      legend.position = "top",
      legend.title = element_text(size = 14, color = "grey20"),
      legend.text = element_text(size = 12, color = "grey50"),
      plot.title = element_text(size = 22, margin = margin(b = 15)),
      plot.subtitle = element_text(size = 14, margin = margin(b = 15)),
      plot.caption = element_text(size = 14, color = "grey50", margin = margin(t = 25)),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      axis.text = element_text(size = 14),
      axis.line.x = element_line(color = "grey20"),
      axis.ticks.x = element_line(color = "grey20"),
      plot.margin = margin(20, 20, 10, 20)
      )

final_plot <- (gg_ye_co_th + gg_ye_co_sec_th) /
  (gg_ye_temp_th + gg_co_temp_th) +
  plot_annotation(
    title = expression(paste("Annual mean temperature and "~CO[2], " emissions relationship over the years in Sevilla (1950-2020)")),
    caption = "   Data source:
      -Moreno A, Hasenauer H (2016). “Spatial downscaling of European climate data” International Journal of Climatology, 1444–1458.
      -Rammer W, Pucher C, Neumann M (2018). Description, Evaluation and Validation of Downscaled Daily Climate Data Version 2.
      -Cruz-Alonso V, Rodríguez-Sánchez F, Pucher C, Ratcliffe S, Astigarraga J, Neumann M, Ruiz-Benito P (2021). easyclimate: Easy access to high-resolution daily climate data for Europe.
      -Crippa M, Guizzardi D, Muntean M, Schaaf E, Solazzo E, Monforti-Ferrario F, Olivier JGJ, Vignati E, Fossil CO2 emissions of all world countries - 2020 Report, EUR 30358 EN,
       Publications Office of the European Union, Luxembourg, 2020.
    Graphic: PhD EBD seminar",
    theme = theme(
      plot.title = element_text(size = 24, face = "bold"),
      plot.caption = element_text(hjust = 0, size = 14, color = "grey50", margin = margin(t = 25))
      )
    )

ggsave(
  plot = final_plot,
  here("05-output", "sevilla_co2_temp.png"),
  width = 20, height = 14
)
```

3\. Useful

```{r useful}
read_all_rds <- function(path){
  path %>%
    dir_ls(regexp = "\\.rds$") |> 
    map(readRDS)
}

rds_files <- read_all_rds(path = here("02-data"))
```

4\. Advanced exercise:

-   Fit a linear model for each sector `lm(Tmean.year ~ co_value, data = .x)` and store it as a list-column
-   Predict the response for the data stored in the `data` column using the corresponding linear model
-   Calculate the correlation between the predicted response and the true response
-   Run in parallel

```{r advanced}
co_temp_nested <- co_temp |>
  drop_na(Sector) |> 
  group_by(Sector) |>
  nest() |> 
  mutate(
    lm_obj = map(data, ~lm(
      Tmean.year ~ co_value, data = .x)),
    pred = map2(lm_obj, data,
                ~predict(.x, .y)),
    cor = map2_dbl(pred, data, ~cor(.x, .y$Tmean.year))
    )

co_temp_nested["pred"][[1]]

co_temp_nested |> 
  pluck("pred", 1)

co_temp_nested

# parallel
plan(multisession, workers = 2)

co_temp_nested <- co_temp |>
  drop_na(Sector) |> 
  group_by(Sector) |>
  nest() |> 
  mutate(
    lm_obj = future_map(data, ~lm(
      Tmean.year ~ co_value, data = .x)),
    pred = future_map2(lm_obj, data,
                ~predict(.x, .y)),
    cor = future_map2_dbl(pred, data, ~cor(.x, .y$Tmean.year))
    )
```

## Recommended reading

-   [R for Data Science](https://r4ds.had.co.nz/) by Hadley Wickham & Garrett Grolemund (the information in this document is based mainly on this book)

-   Wickham et al., (2019). Welcome to the Tidyverse. Journal of Open Source Software, 4(43), 1686, <https://doi.org/10.21105/joss.01686>

-   Core tidyverse packages:

    -   [readr](https://readr.tidyverse.org/): read rectangular data
    -   [tibble](https://tibble.tidyverse.org/): modern reimagining of the data.frame
    -   [tidyr](https://tidyr.tidyverse.org/): tidy data
    -   [dplyr](https://dplyr.tidyverse.org/): data manipulation
    -   [ggplot2](https://ggplot2.tidyverse.org/): data visualisation
    -   [stringr](https://stringr.tidyverse.org/): string manipulation
    -   [forcats](https://forcats.tidyverse.org/): solve problems with factors
    -   [purrr](https://purrr.tidyverse.org/): functional programming

------------------------------------------------------------------------

<details>

<summary>

Session Info

</summary>

```{r session-info}
Sys.time()
git2r::repository()
sessionInfo()
```

</details>

