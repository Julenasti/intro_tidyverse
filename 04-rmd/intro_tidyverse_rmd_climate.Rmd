---
title: "Anthropogenic climate change: a case study of Alcalá de Henares"
author: "Julen Astigarraga, Ignacio Morales-Castilla, Darío San Segundo & Paloma Ruiz-Benito"
date: "`r Sys.Date()`"
output:
  word_document:
    reference_docx: docx_template.docx
bibliography: references.bib
link-citations: yes
csl: apa-no-issue-numbers.csl
editor_options:
  chunk_output_type: console
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = FALSE, eval = TRUE, warning = FALSE, message = FALSE, fig.width = 20, fig.height = 14, dpi = 600)
library(tidyverse)
library(here)
library(patchwork)
library(viridis)
library(ggpmisc)

```

# Problem we are going to work with

In the city council of Alcalá de Henares there are still discrepancies about the existence of anthropogenic climate change. Some parties are of the opinion that it does not exist, others think that it exists but that it is not due to anthropogenic causes and others argue that all the scientific evidence leaves no doubt that it exists and that it is due to anthropogenic causes. The parties that believe that anthropogenic climate change exists have asked you, a group of experts, to produce a report that clearly shows how the increase in CO~2~ emissions has gone hand in hand with the increase in temperature in recent decades. How would you solve this issue?

# Climate & CO~2~ data

-   The data could be obtained, for example, from the following information sources: Climate data for Alcalá de Henares: <https://verughub.github.io/easyclimate/index.html>

-   CO~2~ emissions data for Spain: <https://edgar.jrc.ec.europa.eu/report_2020#data_download>

```{r download data}

## easyclimate

# remotes::install_github("VeruGHub/easyclimate")

library(easyclimate)

coords <- data.frame(
  lon = -3.35,
  lat = 40.48
)

# temp <- get_daily_climate(
#   coords,
#   period = 1950:2020, 
#   climatic_var = c("Tmin", "Tmax")
#   )

# save(temp, file = "00-raw/temp.RData")
# load(here("00-raw", "temp.RData"))

co_data <- read_csv(here("01-data", "co2.csv"))
temp <- read_delim(here("01-data", "temalcala.csv"), delim = ";")

```

```{r tidy data}

co_data_l <- co_data %>% 
  pivot_longer(
    cols = "1970":"2019",
    names_to = "co_year",
    values_to = "co_value"
  )

co_data_l_sp <- co_data_l %>% 
  filter(country_name == "Spain and Andorra") %>% 
  select(!country_name)

temp_sel <- temp %>% 
  select(!c(ID_coords))

daily_tmean <- temp_sel %>%
  mutate(
    Tmean = (Tmin + Tmax) / 2,
    date = as.Date(date),
    month = format(date, format = "%m"),
    year = format(date, format = "%Y")
  )

yearly <- daily_tmean %>% 
  group_by(year) %>% 
  summarise(
    Tmean.year = mean(Tmean)
    )

co_temp <- full_join(
  co_data_l_sp, yearly, by = c("co_year" = "year")
)

co_temp_all <- co_temp %>% 
  mutate(
    co_value = as.numeric(co_value),
    co_year = as.numeric(co_year),
  ) %>% 
  group_by(co_year) %>% 
  summarise(
    co_all = sum(co_value),
    Tmean.year = first(Tmean.year)
  )

```

```{r data vis}

gg_ye_co <- ggplot(co_temp_all, aes(x = co_year, y = co_all,
                                    color = co_year
                                    )) +
  geom_line() +
  geom_smooth(method = "lm")

gg_ye_temp <- ggplot(co_temp_all, aes(x = co_year, y = Tmean.year,
                                      color = co_year
                                      )) +
  geom_point() +
  geom_smooth(method = "lm")

gg_co_temp <- ggplot(co_temp_all, aes(x = co_all, y = Tmean.year)) +
  geom_point() +
  geom_smooth(method = "lm")

co_temp <- co_temp %>% 
  mutate(
    co_value = as.numeric(co_value),
    co_year = as.numeric(co_year),
  )

gg_ye_co_sec <- co_temp %>% 
  drop_na(Sector) %>% 
  ggplot(aes(x = co_year, y = co_value, color = Sector)) +
  geom_line()

co_temp_fs <- co_temp %>% 
  mutate(
    # other = str_detect(Sector, "Other") # stringr
    Sector = fct_relevel(Sector, "Other industrial combustion", after = Inf),
    Sector = fct_relevel(Sector, "Other sectors", after = Inf)
    )

gg_ye_co_sec <- co_temp_fs %>% 
  drop_na(Sector) %>% 
  ggplot(aes(x = co_year, y = co_value, color = Sector)) +
  geom_line()

gg_theme <- function(gg, units, title){
  gg +
    geom_smooth(method = "lm", color = "firebrick", size = 1.3) +
    stat_fit_glance(
        method = "lm",
        label.x = "left",
        label.y = "top",
        method.args = list(formula = y ~ x),
        mapping = aes(
          label = sprintf('italic(R^2)~"="~%.3f~~italic(P)~"="~%.2g',
                          after_stat(r.squared), after_stat(p.value))
        ),
        parse = TRUE
      ) +
    geom_point(alpha = .5) +
    scale_y_continuous(labels = function(x){paste0(x, units)}) +
    scale_color_viridis_c(option = "turbo", direction = -1, name = NULL,
                          breaks = seq(1950, 2020, 10)) +
    guides(color = guide_colorsteps(barwidth = unit(30, "lines"),
                                    barheight = unit(.4, "lines"))) +
    labs(y = NULL, x = NULL,
         title = title) +
    theme(
      panel.grid.major = element_line(colour = "grey90", size = 0.5),
      panel.background = element_blank(),
      panel.grid.minor = element_blank(),
      legend.position = "top",
      legend.title = element_text(size = 14, color = "grey20"),
      legend.text = element_text(size = 12, color = "grey50"),
      plot.title = element_text(size = 22, margin = margin(b = 15)),
      plot.subtitle = element_text(size = 14, margin = margin(b = 15)),
      plot.caption = element_text(size = 14, color = "grey50", margin = margin(t = 25)),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      axis.text = element_text(size = 14),
      axis.line.x = element_line(color = "grey20"),
      axis.ticks.x = element_line(color = "grey20"),
      plot.margin = margin(20, 20, 10, 20)
      )
}

# gg_ye_temp_th <- gg_theme(
#   gg = gg_ye_temp,
#   units = "°C",
#   title = "Annual mean temperature"
# )
# 
# gg_ye_co_th <- gg_theme(
#   gg = gg_ye_co,
#   units = " Mt CO2/yr",
#   title = bquote(Annual~CO[2]~emissions)
# )
# 
# gg_co_temp_th <- gg_theme(
#   gg = gg_co_temp,
#   units = "°C",
#   title = bquote(
#     Annual~mean~temperature~vs~Annual~CO[2]~emissions
#     )
# ) +
#   scale_x_continuous(labels = function(x){paste0(x, " Mt CO2/yr")})

arg_3 <- list(
  gg =list(gg_ye_co, gg_ye_temp, gg_co_temp),
  units = c("°C", "Mt CO2/yr", "°C"),
  title = c(
    "Annual mean temperature",
    "Annual CO2 emissions",
    "Annual mean temperature vs Annual CO2 emissions"
  )
  )

purrr_plots <- arg_3 %>% 
  pmap(gg_theme) %>% 
  reduce(`/`)

gg_ye_co_sec_th <- gg_ye_co_sec +
    geom_point(alpha = .5) +
    scale_y_continuous(labels = function(x){paste0(x, " Mt CO2/yr")}) +
    labs(y = NULL, x = NULL,
         title = bquote(Annual~CO[2]~emissions~by~sectors)) +
    theme(
      panel.grid.major = element_line(colour = "grey90", size = 0.5),
      panel.background = element_blank(),
      panel.grid.minor = element_blank(),
      legend.key = element_blank(),
      legend.position = "top",
      legend.title = element_text(size = 14, color = "grey20"),
      legend.text = element_text(size = 12, color = "grey50"),
      plot.title = element_text(size = 22, margin = margin(b = 15)),
      plot.subtitle = element_text(size = 14, margin = margin(b = 15)),
      plot.caption = element_text(size = 14, color = "grey50", margin = margin(t = 25)),
      plot.title.position = "plot",
      plot.caption.position = "plot",
      axis.text = element_text(size = 14),
      axis.line.x = element_line(color = "grey20"),
      axis.ticks.x = element_line(color = "grey20"),
      plot.margin = margin(20, 20, 10, 20)
      )

final_plot <- (purrr_plots[[1]] + gg_ye_co_sec_th) /
  (purrr_plots[[2]] + purrr_plots[[3]]) +
  plot_annotation(
    title = expression(paste("Annual mean temperature and "~CO[2], " emissions relationship over the years in Alcalá de Henares, Madrid (1950-2020)")),
    caption = "   Data source:
      -Moreno A, Hasenauer H (2016). “Spatial downscaling of European climate data” International Journal of Climatology, 1444–1458.
      -Rammer W, Pucher C, Neumann M (2018). Description, Evaluation and Validation of Downscaled Daily Climate Data Version 2.
      -Cruz-Alonso V, Rodríguez-Sánchez F, Pucher C, Ratcliffe S, Astigarraga J, Neumann M, Ruiz-Benito P (2021). easyclimate: Easy access to high-resolution daily climate data for Europe.
      -Crippa M, Guizzardi D, Muntean M, Schaaf E, Solazzo E, Monforti-Ferrario F, Olivier JGJ, Vignati E, Fossil CO2 emissions of all world countries - 2020 Report, EUR 30358 EN,
       Publications Office of the European Union, Luxembourg, 2020.
    Graphic: Students and teachers of **Ciencia de Datos Práctica: Resolución de Problemas Ambientales Mediante Proyectos (Universidad de Alcalá)** course",
    theme = theme(
      plot.title = element_text(size = 24, face = "bold"),
      plot.caption = element_text(hjust = 0, size = 14, color = "grey50", margin = margin(t = 25))
      )
    )

final_plot

```

# Main results

In agreement with @ipcc2021 we found that there is no doubt that climate change exists and that humans are the main cause of it.

::: {custom-style="align_right"}
Ciencia de Datos Práctica: Resolución de Problemas Ambientales Mediante Proyectos (Universidad de Alcalá)
:::

# References

::: {#refs}
:::

# Appendix
